# üõ´ Sistema de precifica√ß√£o din√¢mica e alertas de viagens

Um sistema distribu√≠do constru√≠do com **Middleware Orientado a Mensagens (MOM)** que simula a descoberta, processamento e armazenamento de pre√ßos de voos em tempo real, incluindo sistema de alertas automatizados e tratamento de falhas com Dead Letter Queue (DLQ).

## üìã Sobre o projeto

Este projeto demonstra a implementa√ß√£o de um pipeline de dados ass√≠ncrono e escal√°vel, utilizando **RabbitMQ** como middleware de mensageria para desacoplar os componentes do sistema. O sistema coleta, processa, armazena, exp√µe informa√ß√µes de pre√ßos de voos e gerencia alertas de pre√ßos de forma cont√≠nua e confi√°vel, com tratamento robusto de falhas.

## üèóÔ∏è Arquitetura do sistema

O sistema √© composto por **7 componentes principais**:

### 1. üê≥ A funda√ß√£o: ambiente de desenvolvimento (Dev Container)
- **O que √©**: Ambiente de desenvolvimento isolado e consistente usando Docker e Docker Compose
- **O que faz**: Configura automaticamente toda a infraestrutura necess√°ria (Python, RabbitMQ, PostgreSQL) com um √∫nico comando

### 2. üè≠ O ponto de partida: produtor de dados
- **Arquivo**: `produtor_de_precos.py`
- **O que faz**: Simula um rob√¥ que descobre novos pre√ßos de voos a cada poucos segundos, funcionando como a fonte prim√°ria de informa√ß√µes do sistema. Al√©m disso, testa automaticamente a DLQ e gera mensagens malformadas propositalmente para demonstra√ß√£o

### 3. üê∞ O cora√ß√£o da comunica√ß√£o: RabbitMQ
- **O que √©**: Middleware Orientado a Mensagens (MOM)
- **O que faz**: Atua como um "carteiro" central, recebendo mensagens do produtor e distribuindo-as para todos os consumidores interessados atrav√©s do t√≥pico `price_update_topic`
- **Infraestrutura DLQ**: Configurado com Dead Letter Exchange e Dead Letter Queue para tratamento de falhas

### 4. üíæ A mem√≥ria do sistema: arquivador e PostgreSQL
- **Arquivo**: `arquivador_historico.py`
- **O que faz**: 
  - Assina o t√≥pico de pre√ßos no RabbitMQ
  - Valida mensagens recebidas
  - Conecta ao PostgreSQL e salva permanentemente na tabela `historico_precos`
  - Envia mensagens problem√°ticas para a DLQ com tratamento robusto de erros

### 5. üß† O motor inteligente: motor de alertas
- **Arquivo**: `motor_de_alertas.py`
- **O que faz**:
  - Monitora todos os pre√ßos publicados no t√≥pico
  - Verifica alertas ativos no banco de dados
  - Dispara notifica√ß√µes quando pre√ßos desejados s√£o encontrados
  - Atualiza status dos alertas para evitar duplica√ß√£o

### 6. üìß O notificador: sistema de notifica√ß√µes
- **Arquivo**: `notificador.py`
- **O que faz**:
  - Processa fila dedicada de notifica√ß√µes
  - Simula envio de e-mails para usu√°rios
  - Confirma processamento das notifica√ß√µes

### 7. üåê A vitrine para o mundo: API Gateway
- **Arquivo**: `api_gateway.py` 
- **O que faz**: 
  - Exp√µe API REST para consultar pre√ßos: `GET /api/v1/voos/recentes`
  - Permite cria√ß√£o de alertas: `POST /api/v1/alertas`
  - Interface de documenta√ß√£o autom√°tica em `/docs`

### 8. ÔøΩ Monitor de DLQ: ferramenta de diagn√≥stico
- **Arquivo**: `dlq_monitor.py`
- **O que faz**:
  - Monitora mensagens na Dead Letter Queue
  - Permite visualizar, reprocessar ou limpar mensagens problem√°ticas
  - Interface interativa para gerenciamento de falhas

## ÔøΩüîÑ Fluxo completo de dados

```
                                   ‚îå‚îÄ [Motor de Alertas] ‚îÄ‚Üí [Fila de Notifica√ß√µes] ‚îÄ‚Üí [Notificador]
                                   ‚îÇ                                                        ‚îÇ
[Produtor] ‚îÄ‚Üí [RabbitMQ] ‚îÄ‚î¨‚îÄ [Arquivador] ‚îÄ‚Üí [PostgreSQL] ‚Üê‚îÄ [API Gateway] ‚Üê‚îÄ [Usu√°rio]   ‚îÇ
                          ‚îÇ        ‚îÇ                                                       ‚îÇ
                          ‚îÇ        ‚îî‚îÄ Mensagens problem√°ticas ‚îÄ‚Üí [DLQ] ‚Üê‚îÄ [Monitor DLQ] ‚Üê‚îÄ‚îò
                          ‚îÇ
                          ‚îî‚îÄ [Outros Consumidores...]
```

### Fluxo de um pre√ßo:
1. **Produtor** gera e publica pre√ßo no t√≥pico RabbitMQ
2. **Arquivador** consome, valida e salva no PostgreSQL
3. **Motor de Alertas** verifica se h√° alertas para esse pre√ßo
4. Se houver match, publica na **Fila de Notifica√ß√µes**
5. **Notificador** processa e "envia" e-mail ao usu√°rio
6. **API Gateway** exp√µe dados para consulta externa

### Fluxo de falhas:
1. Mensagem malformada chega no **Arquivador**
2. Valida√ß√£o falha, mensagem √© rejeitada sem requeue
3. RabbitMQ envia automaticamente para a **DLQ**
4. **Monitor DLQ** permite an√°lise e reprocessamento

## üöÄ Como executar o sistema

### Pr√©-requisitos
- Docker e Docker Compose instalados
- VS Code com extens√£o Dev Containers (recomendado)

### Configura√ß√£o inicial

1. **Clone o reposit√≥rio**:
   ```bash
   git clone https://www.github.com/lucas-pinheiro-costa/tarefa-MOM.git
   cd tarefa-MOM
   ```

2. **Configure o arquivo .env** (crie na raiz do projeto):
   ```bash
   # PostgreSQL
   DB_HOST=postgres
   DB_PORT=5432
   DB_NAME=precos_viagens
   DB_USER=postgres
   DB_PASSWORD=postgres
   
   # RabbitMQ
   RABBITMQ_HOST=rabbitmq
   ```

3. **Inicie o ambiente com Dev Container**:
   - Abra o projeto no VS Code
   - Aceite abrir no Dev Container quando solicitado
   - Ou use: `Ctrl+Shift+P` ‚Üí "Dev Containers: Reopen in Container"

4. **Instale as depend√™ncias**:
   ```bash
   pip install -r requirements.txt
   ```

5. **Configure o banco de dados** (execute no PostgreSQL):
   ```sql
   -- Criar banco
   CREATE DATABASE precos_viagens;
   
   -- Usar o banco
   \c precos_viagens;
   
   -- Tabela de hist√≥rico de pre√ßos
   CREATE TABLE historico_precos (
       id SERIAL PRIMARY KEY,
       id_voo VARCHAR(20) NOT NULL,
       origem VARCHAR(10) NOT NULL,
       destino VARCHAR(10) NOT NULL,
       preco DECIMAL(10,2) NOT NULL,
       timestamp_captura TIMESTAMP NOT NULL,
       data_insercao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
   
   -- Tabela de alertas
   CREATE TABLE alertas (
       id SERIAL PRIMARY KEY,
       email_usuario VARCHAR(255) NOT NULL,
       id_voo VARCHAR(20) NOT NULL,
       origem VARCHAR(10) NOT NULL,
       destino VARCHAR(10) NOT NULL,
       preco_desejado DECIMAL(10,2) NOT NULL,
       status VARCHAR(20) DEFAULT 'ativo',
       data_criacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP
   );
   ```

### Execu√ß√£o do sistema completo

Execute cada componente em um terminal separado:

**Terminal 1 - Produtor de Pre√ßos**:
```bash
python produtor_de_precos.py
```

**Terminal 2 - Arquivador de Hist√≥rico**:
```bash
python arquivador_historico.py
```

**Terminal 3 - Motor de Alertas**:
```bash
python motor_de_alertas.py
```

**Terminal 4 - Notificador**:
```bash
python notificador.py
```

**Terminal 5 - API Gateway**:
```bash
uvicorn api_gateway:app --host 0.0.0.0 --port 5000 --reload
```

## üéØ Demonstra√ß√µes do Sistema

### üîÑ Demonstra√ß√£o 1: O ciclo de vida de um pre√ßo

Esta demonstra√ß√£o mostra como um pre√ßo de voo √© capturado, processado, armazenado e gera alertas.

#### Pr√©-requisitos:
- Sistema b√°sico funcionando (Terminais 1, 2, 3, 4 e 5)
- API Gateway acess√≠vel em `http://localhost:5000`

#### Passos:

1. **Criar um alerta via API**:
   ```bash
   curl -X POST "http://localhost:5000/api/v1/alertas" \
        -H "Content-Type: application/json" \
        -d '{
          "email_usuario": "usuario@exemplo.com",
          "id_voo": "G31420",
          "origem": "NAT",
          "destino": "GRU",
          "preco_desejado": 2000.00
        }'
   ```

2. **Observar os terminais**:
   - **Terminal 1 (Produtor)**: Ver√° pre√ßos sendo gerados
   - **Terminal 2 (Arquivador)**: Ver√° pre√ßos sendo salvos no BD
   - **Terminal 3 (Motor de Alertas)**: Ver√° verifica√ß√£o de alertas
   - **Terminal 4 (Notificador)**: Ver√° notifica√ß√£o sendo enviada quando pre√ßo for ‚â§ R$2000

3. **Verificar dados via API**:
   ```bash
   curl http://localhost:5000/api/v1/voos/recentes
   ```

4. **Resultado esperado**:
   - Pre√ßo capturado ‚Üí Salvo no BD ‚Üí Alerta verificado ‚Üí Notifica√ß√£o enviada
   - Status do alerta mudou para "disparado"

---

### üö® Demonstra√ß√£o 2: Tratando falhas com DLQ (Dead Letter Queue)

Esta demonstra√ß√£o mostra como o sistema lida com mensagens problem√°ticas.

#### Pr√©-requisitos:
- Terminais 1 e 2 rodando (Produtor e Arquivador)

#### Passos:

1. **Observar mensagens malformadas**:
   - O produtor automaticamente envia mensagens malformadas a cada 5 mensagens
   - No **Terminal 1**, procure por: `[‚ò†Ô∏è] Enviando mensagem malformada (teste DLQ)`
   - No **Terminal 2**, procure por: `‚ùå Erro ao processar mensagem` e `Rejeitando mensagem e enviando para a DLQ`

2. **Monitorar a DLQ**:
   ```bash
   # Em um novo terminal
   python dlq_monitor.py
   ```

3. **No monitor, escolher op√ß√µes**:
   - **Op√ß√£o 1**: Verificar quantas mensagens est√£o na DLQ
   - **Op√ß√£o 2**: Visualizar conte√∫do das mensagens problem√°ticas
   - Observe campos ausentes como `preco`

4. **Resultado esperado**:
   - Mensagens malformadas s√£o automaticamente isoladas na DLQ
   - Sistema principal continua funcionando normalmente
   - Mensagens problem√°ticas ficam dispon√≠veis para an√°lise

---

### üîß Demonstra√ß√£o 3: Fechando o ciclo de recupera√ß√£o

Esta demonstra√ß√£o mostra como recuperar mensagens da DLQ ap√≥s corre√ß√£o de problemas.

#### Pr√©-requisitos:
- DLQ com mensagens (da Demonstra√ß√£o 2)
- Monitor DLQ aberto

#### Cen√°rio de "corre√ß√£o":

1. **Simular corre√ß√£o no arquivador** (comentar valida√ß√£o temporariamente):
   - Pare o arquivador (Ctrl+C no Terminal 2)
   - Edite `arquivador_historico.py` e comente a linha de valida√ß√£o:
   ```python
   # validate_message_data(dados_do_preco)  # TEMPOR√ÅRIO: para demonstra√ß√£o
   ```
   - Reinicie o arquivador

2. **Reprocessar mensagens da DLQ**:
   - No monitor DLQ, escolha **Op√ß√£o 3**: "Reprocessar mensagens da DLQ"
   - Confirme com 's'

3. **Observar os terminais**:
   - **Terminal 2**: Ver√° mensagens sendo reprocessadas e salvas
   - **Monitor DLQ**: Mostrar√° quantas mensagens foram reprocessadas

4. **Verificar DLQ vazia**:
   - No monitor, escolha **Op√ß√£o 1** para confirmar que DLQ est√° vazia

5. **Restaurar valida√ß√£o**:
   - Pare o arquivador
   - Descomente a linha de valida√ß√£o
   - Reinicie o arquivador

#### Resultado esperado:
- Mensagens "problem√°ticas" foram recuperadas e processadas
- Ciclo completo de tratamento de falhas demonstrado
- Sistema voltou ao estado normal com valida√ß√µes ativas

## üß™ Testes adicionais do sistema

### 1. Teste de conectividade RabbitMQ
```bash
python ArquivosTemporarios/teste_conexao_rabbitmq.py
```

### 2. Teste da API Gateway
- **Interface interativa**: `http://localhost:5000/docs`
- **Consultar pre√ßos**: `http://localhost:5000/api/v1/voos/recentes`
- **Criar alerta via curl**:
  ```bash
  curl -X POST "http://localhost:5000/api/v1/alertas" \
       -H "Content-Type: application/json" \
       -d '{"email_usuario": "test@example.com", "id_voo": "G31420", "origem": "NAT", "destino": "GRU", "preco_desejado": 1500.00}'
  ```

### 3. Monitoramento do RabbitMQ
- **Interface web**: `http://localhost:15672`
- **Usu√°rio**: `guest` / **Senha**: `guest`
- Visualize exchanges, filas e mensagens em tempo real

### 4. Ferramentas de diagn√≥stico
- **Monitor DLQ**: `python dlq_monitor.py`
- **Logs dos componentes**: Cada terminal mostra logs detalhados
- **Status das filas**: Verifica√ß√£o autom√°tica no produtor a cada 10 mensagens

- **Python 3**: Linguagem principal
- **RabbitMQ**: Middleware de mensageria
- **PostgreSQL**: Banco de dados relacional
- **FastAPI**: Framework para API REST
- **Pika**: Cliente Python para RabbitMQ
- **Docker & Docker Compose**: Containeriza√ß√£o
- **VS Code Dev Containers**: Ambiente de desenvolvimento

## ÔøΩÔ∏è Tecnologias Utilizadas

- **Python 3.11**: Linguagem principal
- **RabbitMQ**: Middleware de mensageria com DLQ
- **PostgreSQL**: Banco de dados relacional
- **FastAPI**: Framework para API REST com documenta√ß√£o autom√°tica
- **Pika**: Cliente Python para RabbitMQ
- **Psycopg2**: Driver PostgreSQL para Python
- **Uvicorn**: Servidor ASGI para FastAPI
- **Docker & Docker Compose**: Containeriza√ß√£o
- **VS Code Dev Containers**: Ambiente de desenvolvimento

## ÔøΩüìÇ Estrutura do Projeto

```
tarefa-MOM/
‚îú‚îÄ‚îÄ üè≠ Componentes principais
‚îÇ   ‚îú‚îÄ‚îÄ produtor_de_precos.py          # Produtor de dados com DLQ monitoring
‚îÇ   ‚îú‚îÄ‚îÄ arquivador_historico.py        # Consumidor com valida√ß√£o e DLQ
‚îÇ   ‚îú‚îÄ‚îÄ motor_de_alertas.py            # Processador de alertas
‚îÇ   ‚îú‚îÄ‚îÄ notificador.py                 # Sistema de notifica√ß√µes
‚îÇ   ‚îî‚îÄ‚îÄ api_gateway.py                 # API REST para consultas e alertas
‚îú‚îÄ‚îÄ üîß Ferramentas de diagn√≥stico
‚îÇ   ‚îî‚îÄ‚îÄ dlq_monitor.py                 # Monitor interativo da DLQ
‚îú‚îÄ‚îÄ üì¶ Configura√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt               # Depend√™ncias Python
‚îÇ   ‚îú‚îÄ‚îÄ .env                          # Vari√°veis de ambiente (criar)
‚îÇ   ‚îî‚îÄ‚îÄ .devcontainer/                # Configura√ß√£o Dev Container
‚îú‚îÄ‚îÄ üìÑ Documenta√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ README.md                     # Este arquivo
‚îÇ
‚îÇ
‚îÇ
‚îÇ
‚îÇ
‚îî‚îÄ‚îÄ üóÉÔ∏è Dados
    ‚îî‚îÄ‚îÄ __pycache__/                  # Cache Python (ignorado pelo git)
```

## üéØ Objetivos de Aprendizado

Este projeto demonstra:

### üì° Middleware Orientado a Mensagens (MOM)
- ‚úÖ Implementa√ß√£o de arquitetura orientada a mensagens
- ‚úÖ Desacoplamento de componentes usando RabbitMQ
- ‚úÖ Padr√µes pub/sub e point-to-point
- ‚úÖ Exchanges, filas e roteamento de mensagens

### üõ°Ô∏è Tratamento de Falhas e Confiabilidade
- ‚úÖ Dead Letter Queue (DLQ) para mensagens problem√°ticas
- ‚úÖ Valida√ß√£o robusta de dados
- ‚úÖ Recovery e reprocessamento de mensagens
- ‚úÖ Acknowledgments manuais para controle de fluxo

### üèóÔ∏è Arquitetura de Microsservi√ßos
- ‚úÖ Pipeline de dados ass√≠ncrono e escal√°vel
- ‚úÖ Separa√ß√£o de responsabilidades
- ‚úÖ Sistema de alertas baseado em eventos
- ‚úÖ Monitoramento e observabilidade

### üîß Integra√ß√£o Tecnol√≥gica
- ‚úÖ Containeriza√ß√£o com Docker e Dev Containers
- ‚úÖ APIs REST com FastAPI e documenta√ß√£o autom√°tica
- ‚úÖ Persist√™ncia de dados com PostgreSQL
- ‚úÖ Desenvolvimento em ambiente isolado

### üìä Padr√µes de Processamento
- ‚úÖ Event-driven architecture
- ‚úÖ Message validation e error handling
- ‚úÖ Workflow de notifica√ß√µes
- ‚úÖ Monitoramento de sistema distribu√≠do

---

## üí° Dicas importantes

- **Ordem de execu√ß√£o**: Sempre inicie o ambiente Dev Container primeiro
- **Logs detalhados**: Cada componente fornece logs coloridos e informativos
- **Interface web RabbitMQ**: Use `http://localhost:15672` para monitoramento visual
- **Documenta√ß√£o API**: Acesse `http://localhost:5000/docs` para interface interativa
- **DLQ Monitoring**: Use o monitor sempre que houver problemas
- **Desenvolvimento**: O sistema suporta hot-reload para facilitar mudan√ßas
